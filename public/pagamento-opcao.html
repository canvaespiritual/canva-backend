<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pagamento - Canva Espiritual</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://sdk.mercadopago.com/js/v2"></script>
</head>
<body class="bg-white text-gray-800 font-sans">
  <div class="max-w-lg mx-auto p-6 text-center">
    <h1 class="text-2xl font-bold text-green-700 mb-4">🔐 Etapa final: Conclua seu Diagnóstico</h1>
    <p class="mb-2 text-gray-700">Gere o PIX abaixo ou pague com cartão de crédito.</p>
    <p class="mb-4 text-sm text-gray-500">Session ID: <span id="session_id" class="font-mono text-xs"></span></p>

    <div id="qrcode" class="my-6 hidden">
      <img id="qrImage" src="" alt="QR Code PIX" class="mx-auto w-60 h-60 border" />
      <p class="mt-3 text-sm text-gray-600">📷 Escaneie o QR Code com seu app bancário</p>
    </div>

    <div id="copiar_pix" class="my-4 hidden">
      <input id="pixCode" class="w-full p-2 border rounded mb-2 text-sm text-center" readonly />
      <button onclick="copiarCodigo()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition">📋 Copiar Código PIX</button>
    </div>

    <div id="formulario-cartao" class="my-8 hidden">
      <h2 class="text-lg font-semibold mb-2 text-gray-800">💳 Pagar com Cartão</h2>
      <div id="wallet_container"></div>
    </div>

    <div id="statusPagamento" class="mt-6 text-sm text-gray-700 font-medium">
      ⏳ Aguardando pagamento...
    </div>
  </div>

<script>
(function () {
  const qs = new URLSearchParams(location.search);
  const tipoOriginal = (qs.get('tipo') || 'basico').toLowerCase();
const tipo = (() => {
  if (['premium','intermediario'].includes(tipoOriginal)) return 'premium';
  if (['completo','interdimensional'].includes(tipoOriginal)) return 'completo';
   return 'basico';
 })();
  const sessionId = qs.get('session_id') || localStorage.getItem('session_id');

  // 🔎 NOVO: detectar afiliado
  const ref = (qs.get('ref') || qs.get('aff') || '').trim();
  const hasAffiliate = !!ref;

  // elementos
  const statusPagamento   = document.getElementById("statusPagamento");
  const qrcode            = document.getElementById("qrcode");
  const qrImage           = document.getElementById("qrImage");
  const copiar_pix        = document.getElementById("copiar_pix");
  const pixCode           = document.getElementById("pixCode");
  const formulario_cartao = document.getElementById("formulario-cartao");

  // mostra o session_id
  const sessionSpan = document.getElementById("session_id");
  if (sessionSpan) sessionSpan.textContent = sessionId || 'N/A';

  const setStatus = (txt) => { statusPagamento.textContent = txt; };

  // 🔁 utilitário: tentar redirecionar a ABA do checkout também
  function redirectChildToAguarde(sessionId) {
    try {
      const winName = sessionStorage.getItem('asaasWinName') || `asaasCheckout_${sessionId}`;
      const w = window.open('', winName); // reabre o handle por nome
      if (w && !w.closed) {
        // mesmo cross-origin, podemos SETAR location do filho
        w.location.href = `/aguarde.html?session_id=${encodeURIComponent(sessionId)}`;
      }
    } catch (_) {}
  }

  async function iniciar() {
    if (!sessionId) {
      setStatus('❌ Sessão não encontrada. Volte e refaça o diagnóstico.');
      return;
    }

    setStatus('🔎 Preparando seu checkout...');
    try {
      // 🔵 NOVO: enviar também "ref" para o backend
      const resp = await fetch('/pagamento/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tipo, session_id: sessionId, ref })
      });
      if (!resp.ok) throw new Error(await resp.text() || `HTTP ${resp.status}`);
      const start = await resp.json();
      console.log('[pagamento/start] =>', start);

      if (start.alreadyPaid && start.redirect) {
        setStatus('✅ Pagamento já aprovado. Redirecionando…');
        // redireciona também a outra aba, se existir
        redirectChildToAguarde(sessionId);
        window.location.href = start.redirect;
        return;
      }

      const urlAsaas = start.checkout_url || start.invoice_url;

      // ✅ Só usa ASAAS se for afiliado E o backend retornou Asaas
      if (hasAffiliate && start.gateway === 'asaas' && urlAsaas) {
        setStatus('🔒 Abrindo checkout seguro do Asaas…');

        // Reaproveita a aba pré-aberta no pagar.html (se existir)
        const winName = sessionStorage.getItem('asaasWinName') || `asaasCheckout_${sessionId}`;
        let w = null;
        try { w = window.open('', winName); } catch (_) {}
        if (w && !w.closed) {
          try { w.location = urlAsaas; } catch (_) {}
          sessionStorage.removeItem('asaasWinName');
          monitorarStatusSessao(sessionId); // usa /status-por-sessao do backend
          return;
        }

        // tenta abrir em nova aba
        const popup = window.open(urlAsaas, '_blank');
        if (popup) {
          monitorarStatusSessao(sessionId);
          return;
        }

        // fallback: sem popup, vai nesta aba
        location.replace(urlAsaas);
        return;
      }

      // 🔁 Caso contrário: força Mercado Pago (fluxo direto)
      iniciarMP();

    } catch (e) {
      console.error('[pagamento-opcao] falha no start:', e);
      setStatus('⚠️ Falha ao iniciar gateway principal. Indo pelo Mercado Pago…');
      iniciarMP(true);
    }
  }

  // ===== Polling por sessão (Asaas) — backend retorna "pago" em /status-por-sessao =====
  function monitorarStatusSessao(sessionId) {
    setStatus("⏳ Aguardando confirmação do pagamento…");
    const it = setInterval(async () => {
      try {
        const r = await fetch(`/pagamento/status-por-sessao/${encodeURIComponent(sessionId)}`);
        const j = await r.json();
        if (j?.aprovado) {
          clearInterval(it);
          localStorage.setItem("pagamento_confirmado", "true");
          setStatus("✅ Pagamento aprovado! Gerando seu relatório…");
          // redireciona a outra aba também
          redirectChildToAguarde(sessionId);
          setTimeout(() => {
            location.href = `/aguarde.html?session_id=${encodeURIComponent(sessionId)}`;
          }, 1200);
        }
      } catch (_) { /* ignora falhas momentâneas */ }
    }, 4000);
  }

  // ===== FLUXO MERCADO PAGO =====
async function iniciarMP(isFallback = false) {
  setStatus(isFallback ? '⚠️ Fallback ativado: Mercado Pago.' : '💳 Preparando Mercado Pago…');

  // MP espera: basico | intermediario | completo
  // (aceita "premium" => "intermediario" e "interdimensional" => "completo")
  const t = String(tipo || '').toLowerCase();
  const tipoForMP =
    t === 'premium' || t === 'intermediario' ? 'intermediario' :
    t === 'completo' || t === 'interdimensional' ? 'completo' :
    'basico';

  // 1) PIX
  try {
    const rPix = await fetch(`/pagamento/criar-pix/${encodeURIComponent(tipoForMP)}/${encodeURIComponent(sessionId)}`);
    const data = await rPix.json();
    if (data?.qr_code) {
      qrcode.classList.remove('hidden');
      qrImage.src = `data:image/png;base64,${data.qr_code_base64}`;
      copiar_pix.classList.remove('hidden');
      pixCode.value = data.qr_code;
      monitorarStatusMP(data.payment_id, sessionId);
    }
  } catch (e) {
    console.warn('[MP] erro ao criar PIX:', e);
  }

  // 2) Cartão (Wallet/Bricks)
  try {
    const rPref = await fetch(`/pagamento/criar-preferencia-embed/${encodeURIComponent(tipoForMP)}/${encodeURIComponent(sessionId)}`);
    const pref = await rPref.json();
    if (pref?.preferenceId) {
      const mp = new MercadoPago("APP_USR-491a3716-8f57-4a13-ab92-fa375fe8cc1c");
      mp.bricks().create("wallet", "wallet_container", {
        initialization: { preferenceId: pref.preferenceId },
        customization: { texts: { valueProp: 'security_safety' } }
      });
      formulario_cartao.classList.remove('hidden');
    }
    setStatus('⏳ Aguardando pagamento (Mercado Pago)…');
  } catch (e) {
    console.warn('[MP] erro ao inicializar Wallet:', e);
    setStatus("⚠️ Cartão indisponível no momento.");
  }
}


  function monitorarStatusMP(paymentId, sessionId) {
    const intervalo = setInterval(async () => {
      try {
        const r = await fetch(`/pagamento/status/${encodeURIComponent(paymentId)}`);
        const data = await r.json();
        if (data.aprovado) {
          clearInterval(intervalo);
          statusPagamento.textContent = "✅ Pagamento aprovado! Gerando seu relatório...";
          localStorage.setItem("pagamento_confirmado", "true");
          // redireciona a outra aba também (caso tenha sido pré-aberta)
          redirectChildToAguarde(sessionId);
          setTimeout(() => {
            window.location.href = `/aguarde.html?session_id=${encodeURIComponent(sessionId)}`;
          }, 3000);
        }
      } catch (_) {}
    }, 5000);
  }

  document.addEventListener('DOMContentLoaded', iniciar);
})();
</script>

</body>
</html>
